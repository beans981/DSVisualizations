<!DOCTYPE html>
<html>
<head>
    <title>
        Linked List Visualization
    </title>

    <!-- css sheet for how the page is laid out -->
    <link rel="stylesheet" href="visualizationPageStyle.css">

    <!-- jqueury stuff.  Only used for the animation speed slider. -->
    <link rel="stylesheet" href="ThirdParty/jquery-ui-1.8.11.custom.css">
    <script src="ThirdParty/jquery-1.5.2.min.js"></script>
    <script src="ThirdParty/jquery-ui-1.8.11.custom.min.js"></script>

    <!-- Javascript for the actual visualization code -->
    <script type="text/javascript" src="AnimationLibrary/CustomEvents.js"></script>
    <script type="text/javascript" src="AnimationLibrary/UndoFunctions.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimatedObject.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimatedLabel.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimatedCircle.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimatedRectangle.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimatedLinkedList.js"></script>
    <script type="text/javascript" src="AnimationLibrary/HighlightCircle.js"></script>
    <script type="text/javascript" src="AnimationLibrary/Line.js"></script>
    <script type="text/javascript" src="AnimationLibrary/ObjectManager.js"></script>
    <script type="text/javascript" src="AnimationLibrary/AnimationMain.js"></script>

    <script type="text/javascript" src="AlgorithmLibrary/Algorithm.js"></script>
    <script>

        var LINKED_LIST_START_X = 200;
        var LINKED_LIST_START_Y = 200;
        var LINKED_LIST_ELEM_WIDTH = 70;
        var LINKED_LIST_ELEM_HEIGHT = 30;

        var LINKED_LIST_INSERT_X = 250;
        var LINKED_LIST_INSERT_Y = 50;

        var LINKED_LIST_ELEMS_PER_LINE = 8;
        var LINKED_LIST_ELEM_SPACING = 100;
        var LINKED_LIST_LINE_SPACING = 100;

        var HEAD_POS_X = 100;
        var HEAD_LABEL_X = 110;
        var HEAD_LABEL_Y = LINKED_LIST_START_Y - LINKED_LIST_ELEM_HEIGHT;

        var HEAD_ELEM_WIDTH = 30;
        var HEAD_ELEM_HEIGHT = 30;

        var INSERT_LABEL_X = 50;
        var INSERT_LABEL_Y = 30;
        var INSERT_ELEMENT_X = 120;
        var INSERT_ELEMENT_Y = 30;

        var SIZE = 32;

        function LinkedList(am, w, h) {
            this.init(am, w, h);
        }

        LinkedList.prototype = new Algorithm();
        LinkedList.prototype.constructor = LinkedList;
        LinkedList.superclass = Algorithm.prototype;


        LinkedList.prototype.init = function (am, w, h) {
            LinkedList.superclass.init.call(this, am, w, h);
            this.addControls();
            this.nextIndex = 0;
            this.commands = [];
            this.head_pos_y = LINKED_LIST_START_Y;
            this.head_label_y = HEAD_LABEL_Y;
            this.p = null; // 初始化指针 p
            this.setup();
            this.initialIndex = this.nextIndex;
        }


        LinkedList.prototype.addControls = function () {
            this.controls = [];
            this.addField = addControlToAlgorithmBar("Text", "");
            this.addField.onkeydown = this.returnSubmit(this.addField, this.addCallback.bind(this), 6);
            this.addButton = addControlToAlgorithmBar("Button", "Add");
            this.addButton.onclick = this.addCallback.bind(this);
            this.controls.push(this.addField);
            this.controls.push(this.addButton);
            // 添加 First 按钮
            this.firstButton = addControlToAlgorithmBar("Button", "First");
            this.firstButton.onclick = this.firstCallback.bind(this);
            this.controls.push(this.firstButton);

            // 添加 Next 按钮
            this.nextButton = addControlToAlgorithmBar("Button", "Next");
            this.nextButton.onclick = this.nextCallback.bind(this);
            this.controls.push(this.nextButton);
            // 添加在 p 前插入按钮
            this.insertBeforePButton = addControlToAlgorithmBar("Button", "Insert");
            this.insertBeforePButton.onclick = this.insertBeforePCallback.bind(this);
            this.controls.push(this.insertBeforePButton);

            this.deleteButton = addControlToAlgorithmBar("Button", "Delete");
            this.deleteButton.onclick = this.deleteCallback.bind(this);
            this.controls.push(this.deleteButton);

            this.clearButton = addControlToAlgorithmBar("Button", "Clear List");
            this.clearButton.onclick = this.clearCallback.bind(this);
            this.controls.push(this.clearButton);




        }

        LinkedList.prototype.enableUI = function (event) {
            for (var i = 0; i < this.controls.length; i++) {
                this.controls[i].disabled = false;
            }
        }

        LinkedList.prototype.disableUI = function (event) {
            for (var i = 0; i < this.controls.length; i++) {
                this.controls[i].disabled = true;
            }
        }


        LinkedList.prototype.setup = function () {
            this.linkedListElemID = new Array(SIZE);
            for (var i = 0; i < SIZE; i++) {
                this.linkedListElemID[i] = this.nextIndex++;
            }
            this.headID = this.nextIndex++;
            this.headLabelID = this.nextIndex++;

            this.arrayData = new Array(SIZE);
            this.length = 0;
            this.leftoverLabelID = this.nextIndex++;

            this.cmd("CreateLabel", this.headLabelID, "Head", HEAD_LABEL_X, HEAD_LABEL_Y);
            // 创建头结点
            this.cmd("CreateLinkedList", this.headID, "dummy", LINKED_LIST_ELEM_WIDTH, LINKED_LIST_ELEM_HEIGHT, HEAD_POS_X, this.head_pos_y, 0.25, 0, 1, 1);
            this.cmd("SetNull", this.headID, 1);

            this.cmd("CreateLabel", this.leftoverLabelID, "", 5, INSERT_LABEL_Y, 0);

            this.animationManager.StartNewAnimation(this.commands);
            this.animationManager.skipForward();
            this.animationManager.clearHistory();
        }

        LinkedList.prototype.resetLinkedListPositions = function () {
            for (var i = 0; i < this.length; i++) {
                var nextX = i % LINKED_LIST_ELEMS_PER_LINE * LINKED_LIST_ELEM_SPACING + LINKED_LIST_START_X;
                var nextY = Math.floor(i / LINKED_LIST_ELEMS_PER_LINE) * LINKED_LIST_LINE_SPACING + LINKED_LIST_START_Y;
                this.cmd("Move", this.linkedListElemID[i], nextX, nextY);
            }
        }


        LinkedList.prototype.reset = function () {
            this.length = 0;
            this.nextIndex = this.initialIndex;
            this.p = null; // 重置指针 p
        }


        LinkedList.prototype.addCallback = function (event) {
            if (this.length < SIZE && this.addField.value != "") {
                var insertVal = this.addField.value;
                this.addField.value = "";
                this.implementAction(this.add.bind(this), insertVal);
            }
        }


        LinkedList.prototype.deleteCallback = function (event) {
            if (this.length > 0&&this.p!=null) {
                this.implementAction(this.delete.bind(this), "");
                if (this.p === this.length) {
                    this.p = null; // 如果删除的是当前指针指向的节点，重置指针
                }
            }
        }


        LinkedList.prototype.clearCallback = function (event) {
            this.implementAction(this.clearAll.bind(this), "");
            this.p = null; // 清空链表时重置指针
        }
        LinkedList.prototype.firstCallback = function (event) {
            if (this.length > 0) {
                var pre=this.p
                this.p=0
                this.commands = [];
                this.implementAction(this.position.bind(this),pre);
            }
        };
        LinkedList.prototype.position = function (pre) {

            // 创建高亮对象（如果还没有创建）
            if (!this.highlightID) {
                this.highlightID = this.nextIndex++;
                this.cmd("CreateRectangle", this.highlightID, "p", 20, 20, INSERT_ELEMENT_X, INSERT_ELEMENT_Y);
            }

            if (pre!=null) {
                this.cmd("Disconnect", this.highlightID, this.linkedListElemID[pre]);
            }

            this.cmd("connect", this.highlightID, this.linkedListElemID[this.p]);
            var nextX = this.p % LINKED_LIST_ELEMS_PER_LINE * LINKED_LIST_ELEM_SPACING + LINKED_LIST_START_X;
            var nextY = Math.floor(this.p / LINKED_LIST_ELEMS_PER_LINE) * LINKED_LIST_LINE_SPACING + LINKED_LIST_START_Y;
            this.cmd("Move", this.highlightID, nextX, nextY - 50);
            // 显示高亮对象
            this.cmd("Show", this.highlightID);
            return this.commands;
        };

        LinkedList.prototype.nextCallback = function (event) {
            if (this.p !== null && this.p < this.length - 1) {
                var pre=this.p
                this.p++; // 指针 p 指向下一个节点
                this.commands = [];
                this.implementAction(this.position.bind(this),pre);
            }
        }

        LinkedList.prototype.add = function (elemToInsert) {
            this.commands = new Array();
            this.arrayData[this.length] = elemToInsert;
            this.cmd("SetText", this.leftoverLabelID, "");
            this.linkedListElemID[this.length] = this.nextIndex++;
            var labInsertID = this.nextIndex++;
            var labInsertValID = this.nextIndex++;
            this.cmd("CreateLinkedList", this.linkedListElemID[this.length], "", LINKED_LIST_ELEM_WIDTH, LINKED_LIST_ELEM_HEIGHT,
                LINKED_LIST_INSERT_X, LINKED_LIST_INSERT_Y, 0.25, 0, 1, 1);

            this.cmd("SetNull", this.linkedListElemID[this.length], 1);
            this.cmd("CreateLabel", labInsertID, "Adding Value: ", INSERT_LABEL_X, INSERT_LABEL_Y);
            this.cmd("CreateLabel", labInsertValID, elemToInsert, INSERT_ELEMENT_X, INSERT_ELEMENT_Y);

            this.cmd("Step");

            this.cmd("Move", labInsertValID, LINKED_LIST_INSERT_X, LINKED_LIST_INSERT_Y);

            this.cmd("Step");
            this.cmd("SetText", this.linkedListElemID[this.length], elemToInsert);
            this.cmd("Delete", labInsertValID);

            if (this.length == 0) {
                this.cmd("SetNull", this.headID, 0);
                this.cmd("connect", this.headID, this.linkedListElemID[this.length]);
            } else {
                // 更新连接关系
                this.cmd("SetNull", this.headID, 0);
                //this.cmd("Connect", this.headID, this.linkedListElemID[this.length]);
                this.cmd("Connect", this.linkedListElemID[this.length - 1], this.linkedListElemID[this.length]);
                this.cmd("SetNull", this.linkedListElemID[this.length - 1], 0);
            }

            this.cmd("Step");
            this.length = this.length + 1;
            this.resetLinkedListPositions();
            this.cmd("Delete", labInsertID);
            this.cmd("Step");

            return this.commands;
        }
        // 新增插入在 p 前的回调函数
        LinkedList.prototype.insertBeforePCallback = function (event) {
            if (this.p!== null && this.length < SIZE && this.addField.value != "") {
                var insertVal = this.addField.value;
                this.addField.value = "";
                this.implementAction(this.insertBeforeP.bind(this), insertVal);
            }
            else
            {

            }
        }

        // 新增在 p 前插入的函数
        LinkedList.prototype.insertBeforeP = function (elemToInsert) {
            this.commands = new Array();

            this.cmd("SetText", this.leftoverLabelID, "");

            // 向后移动 arrayData 和 linkedListElemID 中的元素
            for (let i = this.length; i > this.p; i--) {
                this.arrayData[i] = this.arrayData[i - 1];
                this.linkedListElemID[i] = this.linkedListElemID[i - 1];
            }

            // 插入新元素到 p 位置
            this.arrayData[this.p] = elemToInsert;
            this.linkedListElemID[this.p] = this.nextIndex++;

            var labInsertID = this.nextIndex++;
            var labInsertValID = this.nextIndex++;

            this.cmd("CreateLinkedList", this.linkedListElemID[this.p], "", LINKED_LIST_ELEM_WIDTH, LINKED_LIST_ELEM_HEIGHT,
                LINKED_LIST_INSERT_X, LINKED_LIST_INSERT_Y, 0.25, 0, 1, 1);

            //this.cmd("SetNull", this.linkedListElemID[this.p], 1);
            this.cmd("CreateLabel", labInsertID, "Adding Value: ", INSERT_LABEL_X, INSERT_LABEL_Y);
            this.cmd("CreateLabel", labInsertValID, elemToInsert, INSERT_ELEMENT_X, INSERT_ELEMENT_Y);

            this.cmd("Step");

            this.cmd("Move", labInsertValID, LINKED_LIST_INSERT_X, LINKED_LIST_INSERT_Y);

            this.cmd("Step");
            this.cmd("SetText", this.linkedListElemID[this.p], elemToInsert);
            this.cmd("Delete", labInsertValID);

            // 调整连接关系
            if (this.p === 0) {
                this.cmd("Disconnect", this.headID, this.linkedListElemID[1]);
                this.cmd("connect", this.headID, this.linkedListElemID[0]);
                this.cmd("connect", this.linkedListElemID[0], this.linkedListElemID[1]);
            } else {
                this.cmd("Disconnect", this.linkedListElemID[this.p - 1], this.linkedListElemID[this.p + 1]);
                this.cmd("connect", this.linkedListElemID[this.p - 1], this.linkedListElemID[this.p]);
                this.cmd("connect", this.linkedListElemID[this.p], this.linkedListElemID[this.p + 1]);
            }

            this.cmd("Step");
            this.length = this.length + 1;

            this.resetLinkedListPositions();
            this.cmd("Delete", labInsertID);
            this.cmd("Step");

            var pre=this.p
            this.p++

            this.position(pre);
            return this.commands;
        };


        LinkedList.prototype.delete = function (ignored) {
            this.commands = new Array();

            var labDeleteID = this.nextIndex++;
            var labDeleteValID = this.nextIndex++;

            this.cmd("SetText", this.leftoverLabelID, "");

            this.cmd("CreateLabel", labDeleteID, "Deleting Value: ", INSERT_LABEL_X, INSERT_LABEL_Y);
            this.cmd("CreateLabel", labDeleteValID, this.arrayData[this.p], LINKED_LIST_START_X, LINKED_LIST_START_Y);

            this.cmd("Move", labDeleteValID, INSERT_ELEMENT_X, INSERT_ELEMENT_Y);
            this.cmd("Step");

            if (this.length === 1) {
                this.cmd("SetNull", this.headID, 1);
            } else {
                if (this.p === 0) {
                    // 如果删除的是头节点
                    this.cmd("Disconnect", this.headID, this.linkedListElemID[0]);
                    this.cmd("Connect", this.headID, this.linkedListElemID[1]);
                } else {

                    if(this.p==this.length-1)
                    {
                        this.cmd("SetNull", this.linkedListElemID[this.p - 1],1);
                    }
                    else {
                        // 断开前一个节点和要删除节点的连接，连接前一个节点和后一个节点
                        this.cmd("Disconnect", this.linkedListElemID[this.p - 1], this.linkedListElemID[this.p]);
                        this.cmd("Connect", this.linkedListElemID[this.p - 1], this.linkedListElemID[this.p + 1]);
                    }
                }
            }

            this.cmd("Step");
            this.cmd("Delete", this.linkedListElemID[this.p]);

            // 将 this.arrayData 和 this.linkedListElemID 中 this.p 之后的元素向前移动
            for (let i = this.p; i < this.length - 1; i++) {
                this.arrayData[i] = this.arrayData[i + 1];
                this.linkedListElemID[i] = this.linkedListElemID[i + 1];
            }

            if(this.p==this.length-1)
            {
                this.p--;
                if(this.p<0)
                {
                    this.p=null
                }
            }
            this.length = this.length - 1;
            if (this.length === 0) {
                this.cmd("Delete", this.highlightID);
                this.highlightID=null
            }
            this.resetLinkedListPositions();

            this.cmd("Delete", labDeleteValID);
            this.cmd("Delete", labDeleteID);
           if(this.p!=null) {
               this.cmd("connect", this.highlightID, this.linkedListElemID[this.p]);
               var nextX = this.p % LINKED_LIST_ELEMS_PER_LINE * LINKED_LIST_ELEM_SPACING + LINKED_LIST_START_X;
               var nextY = Math.floor(this.p / LINKED_LIST_ELEMS_PER_LINE) * LINKED_LIST_LINE_SPACING + LINKED_LIST_START_Y;

               this.cmd("Move", this.highlightID, nextX, nextY - 50);
               // 显示高亮对象
               //this.cmd("Show", this.highlightID);
           }
            return this.commands;
        };

        LinkedList.prototype.clearAll = function () {
            this.commands = new Array();
            for (var i = 0; i < this.length; i++) {
                this.cmd("Delete", this.linkedListElemID[i]);
            }
            this.length = 0;
            this.p=null
            if(this.highlightID) {
                this.cmd("Delete", this.highlightID);
                this.highlightID = null
            }
            this.cmd("SetNull", this.headID, 1);
            return this.commands;
        }

        var currentAlg;

        function init() {
            var animManag = initCanvas();
            currentAlg = new LinkedList(animManag, canvas.width, canvas.height);
        }
    </script>
</head>

<body onload="init();" class="VisualizationMainPage">
<div id="container">
    <div id="header">
        <h1>Linked List</h1>
    </div>
    <div id="mainContent">
        <div id="algoControlSection">
            <!-- Table for buttons to control specific animation (insert/find/etc) -->
            <!-- (filled in by javascript code specific to the animtion) -->
            <table id="AlgorithmSpecificControls"></table>
        </div>
        <!-- Drawing canvas where all animation is done.  Note:  can be resized in code -->
        <canvas id="canvas" width="1000" height="500"></canvas>
        <div id="generalAnimationControlSection">
            <!-- Table for buttons to control general animation (play/pause/undo/etc) ->
            <!-- (filled in by javascript code, specifically AnimationMain.js)  -->
            <table id="GeneralAnimationControls"></table>
        </div>
    </div> <!-- mainContent -->
    <div id="footer">
        <p><a href="Algorithms.html">Algorithm Visualizations</a></p>
    </div>
</div><!-- container -->
</body>
</html>